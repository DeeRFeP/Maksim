from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackContext, filters
import asyncio
import threading
from PIL import Image
import pystray

TOKEN = '8044601107:AAG3cVeSZuS2pmFCOiMeh6ilwSCWd6RT0qs'
YOUR_CHAT_ID = '8153617358'

# Dictionary of country codes with Russian names
country_codes = {
    '1': '–°–®–ê/–ö–∞–Ω–∞–¥–∞',
    '7': '–†–æ—Å—Å–∏—è',
    '20': '–ï–≥–∏–ø–µ—Ç',
    '27': '–Æ–∂–Ω–∞—è –ê—Ñ—Ä–∏–∫–∞',
    '30': '–ì—Ä–µ—Ü–∏—è',
    '31': '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã',
    '32': '–ë–µ–ª—å–≥–∏—è',
    '33': '–§—Ä–∞–Ω—Ü–∏—è',
    '34': '–ò—Å–ø–∞–Ω–∏—è',
    '36': '–í–µ–Ω–≥—Ä–∏—è',
    '39': '–ò—Ç–∞–ª–∏—è',
    '40': '–†—É–º—ã–Ω–∏—è',
    '41': '–®–≤–µ–π—Ü–∞—Ä–∏—è',
    '43': '–ê–≤—Å—Ç—Ä–∏—è',
    '44': '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',
    '45': '–î–∞–Ω–∏—è',
    '46': '–®–≤–µ—Ü–∏—è',
    '47': '–ù–æ—Ä–≤–µ–≥–∏—è',
    '48': '–ü–æ–ª—å—à–∞',
    '49': '–ì–µ—Ä–º–∞–Ω–∏—è',
    '51': '–ü–µ—Ä—É',
    '52': '–ú–µ–∫—Å–∏–∫–∞',
    '53': '–ö—É–±–∞',
    '54': '–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞',
    '55': '–ë—Ä–∞–∑–∏–ª–∏—è',
    '56': '–ß–∏–ª–∏',
    '57': '–ö–æ–ª—É–º–±–∏—è',
    '58': '–í–µ–Ω–µ—Å—É—ç–ª–∞',
    '60': '–ú–∞–ª–∞–π–∑–∏—è',
    '61': '–ê–≤—Å—Ç—Ä–∞–ª–∏—è',
    '62': '–ò–Ω–¥–æ–Ω–µ–∑–∏—è',
    '63': '–§–∏–ª–∏–ø–ø–∏–Ω—ã',
    '64': '–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è',
    '65': '–°–∏–Ω–≥–∞–ø—É—Ä',
    '66': '–¢–∞–∏–ª–∞–Ω–¥',
    '81': '–Ø–ø–æ–Ω–∏—è',
    '82': '–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è',
    '84': '–í—å–µ—Ç–Ω–∞–º',
    '86': '–ö–∏—Ç–∞–π',
    '90': '–¢—É—Ä—Ü–∏—è',
    '91': '–ò–Ω–¥–∏—è',
    '92': '–ü–∞–∫–∏—Å—Ç–∞–Ω',
    '93': '–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω',
    '94': '–®—Ä–∏-–õ–∞–Ω–∫–∞',
    '95': '–ú—å—è–Ω–º–∞',
    '98': '–ò—Ä–∞–Ω',
    '211': '–Æ–∂–Ω—ã–π –°—É–¥–∞–Ω',
    '212': '–ú–∞—Ä–æ–∫–∫–æ',
    '213': '–ê–ª–∂–∏—Ä',
    '216': '–¢—É–Ω–∏—Å',
    '218': '–õ–∏–≤–∏—è',
    '220': '–ì–∞–º–±–∏—è',
    '221': '–°–µ–Ω–µ–≥–∞–ª',
    '222': '–ú–∞–≤—Ä–∏—Ç–∞–Ω–∏—è',
    '223': '–ú–∞–ª–∏',
    '224': '–ì–≤–∏–Ω–µ—è',
    '225': '–ö–æ—Ç-–¥‚Äô–ò–≤—É–∞—Ä',
    '226': '–ë—É—Ä–∫–∏–Ω–∞-–§–∞—Å–æ',
    '227': '–ù–∏–≥–µ—Ä',
    '228': '–¢–æ–≥–æ',
    '229': '–ë–µ–Ω–∏–Ω',
    '230': '–ú–∞–≤—Ä–∏–∫–∏–π',
    '231': '–õ–∏–±–µ—Ä–∏—è',
    '232': '–°—å–µ—Ä—Ä–∞-–õ–µ–æ–Ω–µ',
    '233': '–ì–∞–Ω–∞',
    '234': '–ù–∏–≥–µ—Ä–∏—è',
    '235': '–ß–∞–¥',
    '236': '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–∞—Ñ—Ä–∏–∫–∞–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞',
    '237': '–ö–∞–º–µ—Ä—É–Ω',
    '238': '–ö–∞–±–æ-–í–µ—Ä–¥–µ',
    '239': '–°–∞–Ω-–¢–æ–º–µ –∏ –ü—Ä–∏–Ω—Å–∏–ø–∏',
    '240': '–≠–∫–≤–∞—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è –ì–≤–∏–Ω–µ—è',
    '241': '–ì–∞–±–æ–Ω',
    '242': '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–Ω–≥–æ',
    '243': '–î–µ–º–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–Ω–≥–æ',
    '244': '–ê–Ω–≥–æ–ª–∞',
    '245': '–ì–≤–∏–Ω–µ—è-–ë–∏—Å–∞—É',
    '246': '–ë—Ä–∏—Ç–∞–Ω—Å–∫–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –≤ –ò–Ω–¥–∏–π—Å–∫–æ–º –æ–∫–µ–∞–Ω–µ',
    '248': '–°–µ–π—à–µ–ª—ã',
    '249': '–°—É–¥–∞–Ω',
    '250': '–†—É–∞–Ω–¥–∞',
    '251': '–≠—Ñ–∏–æ–ø–∏—è',
    '252': '–°–æ–º–∞–ª–∏',
    '253': '–î–∂–∏–±—É—Ç–∏',
    '254': '–ö–µ–Ω–∏—è',
    '255': '–¢–∞–Ω–∑–∞–Ω–∏—è',
    '256': '–£–≥–∞–Ω–¥–∞',
    '257': '–ë—É—Ä—É–Ω–¥–∏',
    '258': '–ú–æ–∑–∞–º–±–∏–∫',
    '260': '–ó–∞–º–±–∏—è',
    '261': '–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä',
    '262': '–†–µ—é–Ω—å–æ–Ω/–ú–∞–π–æ—Ç—Ç–∞',
    '263': '–ó–∏–º–±–∞–±–≤–µ',
    '264': '–ù–∞–º–∏–±–∏—è',
    '265': '–ú–∞–ª–∞–≤–∏',
    '266': '–õ–µ—Å–æ—Ç–æ',
    '267': '–ë–æ—Ç—Å–≤–∞–Ω–∞',
    '268': '–≠—Å–≤–∞—Ç–∏–Ω–∏',
    '269': '–ö–æ–º–æ—Ä—ã',
    '290': '–û—Å—Ç—Ä–æ–≤ –°–≤—è—Ç–æ–π –ï–ª–µ–Ω—ã',
    '291': '–≠—Ä–∏—Ç—Ä–µ—è',
    '297': '–ê—Ä—É–±–∞',
    '298': '–§–∞—Ä–µ—Ä—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞',
    '299': '–ì—Ä–µ–Ω–ª–∞–Ω–¥–∏—è',
    '350': '–ì–∏–±—Ä–∞–ª—Ç–∞—Ä',
    '351': '–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è',
    '352': '–õ—é–∫—Å–µ–º–±—É—Ä–≥',
    '353': '–ò—Ä–ª–∞–Ω–¥–∏—è',
    '354': '–ò—Å–ª–∞–Ω–¥–∏—è',
    '355': '–ê–ª–±–∞–Ω–∏—è',
    '356': '–ú–∞–ª—å—Ç–∞',
    '357': '–ö–∏–ø—Ä',
    '358': '–§–∏–Ω–ª—è–Ω–¥–∏—è',
    '359': '–ë–æ–ª–≥–∞—Ä–∏—è',
    '370': '–õ–∏—Ç–≤–∞',
    '371': '–õ–∞—Ç–≤–∏—è',
    '372': '–≠—Å—Ç–æ–Ω–∏—è',
    '373': '–ú–æ–ª–¥–æ–≤–∞',
    '374': '–ê—Ä–º–µ–Ω–∏—è',
    '375': '–ë–µ–ª–∞—Ä—É—Å—å',
    '376': '–ê–Ω–¥–æ—Ä—Ä–∞',
    '377': '–ú–æ–Ω–∞–∫–æ',
    '378': '–°–∞–Ω-–ú–∞—Ä–∏–Ω–æ',
    '379': '–í–∞—Ç–∏–∫–∞–Ω',
    '380': '–£–∫—Ä–∞–∏–Ω–∞',
    '381': '–ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è',
    '382': '–°–µ—Ä–±–∏—è',
    '383': '–ö–æ—Å–æ–≤–æ',
    '385': '–•–æ—Ä–≤–∞—Ç–∏—è',
    '386': '–°–ª–æ–≤–µ–Ω–∏—è',
    '387': '–ë–æ—Å–Ω–∏—è –∏ –ì–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞',
    '389': '–°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è',
    '420': '–ß–µ—Ö–∏—è',
    '421': '–°–ª–æ–≤–∞–∫–∏—è',
    '423': '–õ–∏—Ö—Ç–µ–Ω—à—Ç–µ–π–Ω',
    '500': '–§–æ–ª–∫–ª–µ–Ω–¥—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞',
    '501': '–ë–µ–ª–∏–∑',
    '502': '–ì–≤–∞—Ç–µ–º–∞–ª–∞',
    '503': '–°–∞–ª—å–≤–∞–¥–æ—Ä',
    '504': '–ì–æ–Ω–¥—É—Ä–∞—Å',
    '505': '–ù–∏–∫–∞—Ä–∞–≥—É–∞',
    '506': '–ö–æ—Å—Ç–∞-–†–∏–∫–∞',
    '507': '–ü–∞–Ω–∞–º–∞',
    '508': '–°–µ–Ω-–ü—å–µ—Ä –∏ –ú–∏–∫–µ–ª–æ–Ω',
    '509': '–ì–∞–∏—Ç–∏',
    '590': '–ì–≤–∞–¥–µ–ª—É–ø–∞',
    '591': '–ë–æ–ª–∏–≤–∏—è',
    '592': '–ì–∞–π–∞–Ω–∞',
    '593': '–≠–∫–≤–∞–¥–æ—Ä',
    '594': '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è –ì–≤–∏–∞–Ω–∞',
    '595': '–ü–∞—Ä–∞–≥–≤–∞–π',
    '596': '–ú–∞—Ä—Ç–∏–Ω–∏–∫–∞',
    '597': '–°—É—Ä–∏–Ω–∞–º',
    '598': '–£—Ä—É–≥–≤–∞–π',
    '599': '–ö—é—Ä–∞—Å–∞–æ/–ö–∞—Ä–∏–±—Å–∫–∏–µ –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã',
    '670': '–í–æ—Å—Ç–æ—á–Ω—ã–π –¢–∏–º–æ—Ä',
    '672': '–ê–≤—Å—Ç—Ä–∞–ª–∏–π—Å–∫–∏–µ –≤–Ω–µ—à–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏',
    '673': '–ë—Ä—É–Ω–µ–π',
    '674': '–ù–∞—É—Ä—É',
    '675': '–ü–∞–ø—É–∞-–ù–æ–≤–∞—è –ì–≤–∏–Ω–µ—è',
    '676': '–¢–æ–Ω–≥–∞',
    '677': '–°–æ–ª–æ–º–æ–Ω–æ–≤—ã –û—Å—Ç—Ä–æ–≤–∞',
    '678': '–í–∞–Ω—É–∞—Ç—É',
    '679': '–§–∏–¥–∂–∏',
    '680': '–ü–∞–ª–∞—É',
    '681': '–£–æ–ª–ª–∏—Å –∏ –§—É—Ç—É–Ω–∞',
    '682': '–û—Å—Ç—Ä–æ–≤–∞ –ö—É–∫–∞',
    '683': '–ù–∏—É—ç',
    '685': '–°–∞–º–æ–∞',
    '686': '–ö–∏—Ä–∏–±–∞—Ç–∏',
    '687': '–ù–æ–≤–∞—è –ö–∞–ª–µ–¥–æ–Ω–∏—è',
    '688': '–¢—É–≤–∞–ª—É',
    '689': '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è –ü–æ–ª–∏–Ω–µ–∑–∏—è',
    '690': '–¢–æ–∫–µ–ª–∞—É',
    '691': '–ú–∏–∫—Ä–æ–Ω–µ–∑–∏—è',
    '692': '–ú–∞—Ä—à–∞–ª–ª–æ–≤—ã –û—Å—Ç—Ä–æ–≤–∞',
    '850': '–°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è',
    '852': '–ì–æ–Ω–∫–æ–Ω–≥',
    '853': '–ú–∞–∫–∞–æ',
    '855': '–ö–∞–º–±–æ–¥–∂–∞',
    '856': '–õ–∞–æ—Å',
    '880': '–ë–∞–Ω–≥–ª–∞–¥–µ—à',
    '886': '–¢–∞–π–≤–∞–Ω—å',
    '960': '–ú–∞–ª—å–¥–∏–≤—ã',
    '961': '–õ–∏–≤–∞–Ω',
    '962': '–ò–æ—Ä–¥–∞–Ω–∏—è',
    '963': '–°–∏—Ä–∏—è',
    '964': '–ò—Ä–∞–∫',
    '965': '–ö—É–≤–µ–π—Ç',
    '966': '–°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è',
    '967': '–ô–µ–º–µ–Ω',
    '968': '–û–º–∞–Ω',
    '970': '–ü–∞–ª–µ—Å—Ç–∏–Ω–∞',
    '971': '–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –ê—Ä–∞–±—Å–∫–∏–µ –≠–º–∏—Ä–∞—Ç—ã',
    '972': '–ò–∑—Ä–∞–∏–ª—å',
    '973': '–ë–∞—Ö—Ä–µ–π–Ω',
    '974': '–ö–∞—Ç–∞—Ä',
    '975': '–ë—É—Ç–∞–Ω',
    '976': '–ú–æ–Ω–≥–æ–ª–∏—è',
    '977': '–ù–µ–ø–∞–ª',
    '992': '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω',
    '993': '–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω',
    '994': '–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω',
    '995': '–ì—Ä—É–∑–∏—è',
    '996': '–ö–∏—Ä–≥–∏–∑–∏—è',
    '998': '–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω'
}

def get_country_name(phone_number):
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
    if phone_number.startswith('+'):
        # –ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–±–µ–ª –∏–ª–∏ –≤–∑—è—Ç—å –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ '+'
        space_index = phone_number.find(' ')
        if space_index != -1:
            country_code = phone_number[1:space_index]
        else:
            # –ï—Å–ª–∏ –ø—Ä–æ–±–µ–ª–æ–≤ –Ω–µ—Ç, –≤–∑—è—Ç—å –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä (–æ–±—ã—á–Ω–æ –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 1-3 —Ü–∏—Ñ—Ä)
            country_code = phone_number[1:4]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ —Ç—Ä–∏ —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ '+'

        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º—ã –Ω–µ –≤–∑—è–ª–∏ –ª–∏—à–Ω–∏–µ —Ü–∏—Ñ—Ä—ã
        for length in range(1, 4):
            if country_code[:length] in country_codes:
                country_code = country_code[:length]
                break
    else:
        country_code = phone_number[0:3]  # –ï—Å–ª–∏ –Ω–µ—Ç '+', –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ —Ç—Ä–∏ —Ü–∏—Ñ—Ä—ã

    print(f"–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã: {country_code}")  # –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–¥–∞ –≤ —Å–ª–æ–≤–∞—Ä–µ
    country_name = country_codes.get(country_code, "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ")
    print(f"–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã: {country_name}")  # –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

    return country_name

class TelegramBot:
    def __init__(self):
        self.application = None
        self.loop = asyncio.new_event_loop()

    async def run(self):
        self.application = Application.builder().token(TOKEN).build()
        self.application.add_handler(CommandHandler("start", self.start))
        self.application.add_handler(MessageHandler(filters.CONTACT, self.handle_contact))

        await self.application.initialize()
        await self.application.start()
        await self.application.updater.start_polling()

        # Infinite waiting
        while True:
            await asyncio.sleep(3600)

    async def start(self, update: Update, context: CallbackContext):
        contact_button = KeyboardButton("üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç", request_contact=True)
        reply_markup = ReplyKeyboardMarkup([[contact_button]], resize_keyboard=True)
        await update.message.reply_text(
            '–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º.',
            reply_markup=reply_markup
        )

    async def handle_contact(self, update: Update, context: CallbackContext):
        user = update.message.from_user
        contact = update.message.contact

        # Get country
        country_name = get_country_name(contact.phone_number)

        # Get profile photo
        try:
            profile_photos = await context.bot.get_user_profile_photos(user.id)
            photo_file = None
            if profile_photos.total_count > 0:
                photo = profile_photos.photos[0][-1]
                photo_file = await photo.get_file()
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: {e}")
            photo_file = None

        # Form user information
        user_info = (
            f"üÜî ID: {user.id}\n"
            f"üë§ –ò–º—è: {user.first_name}\n"
            f"üì± –ù–æ–º–µ—Ä: {contact.phone_number}\n"
            f"üåç –°—Ç—Ä–∞–Ω–∞: {country_name}\n"
            f"üîó Username: @{user.username if user.username else '–Ω–µ—Ç'}"
        )

        # Send to admin
        try:
            if photo_file:
                await context.bot.send_photo(
                    chat_id=YOUR_CHAT_ID,
                    photo=photo_file.file_id,
                    caption=user_info
                )
            else:
                await context.bot.send_message(
                    chat_id=YOUR_CHAT_ID,
                    text=user_info + "\n\nüì∑ –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
                )

            # Forward the contact to the admin
            await context.bot.forward_message(
                chat_id=YOUR_CHAT_ID,
                from_chat_id=update.message.chat_id,
                message_id=update.message.message_id
            )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")

        # Reply to user
        await update.message.reply_text(
            '‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã, –æ–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.',
            reply_markup=ReplyKeyboardRemove()
        )

def create_tray_icon(loop):
    # Load the icon image
    image = Image.open("icon.png")

    # Create the tray icon
    icon = pystray.Icon("Telegram Bot", image, "Telegram Bot")

    # Define the menu
    menu = pystray.Menu(
        pystray.MenuItem("Exit", lambda: (loop.stop(), icon.stop()))
    )

    icon.menu = menu
    icon.run()

if __name__ == '__main__':
    bot = TelegramBot()

    # Start the bot in a separate thread
    threading.Thread(target=bot.loop.run_until_complete, args=(bot.run(),)).start()

    # Create and run the tray icon
    create_tray_icon(bot.loop)
